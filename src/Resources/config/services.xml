<?xml version="1.0" encoding="UTF-8" ?>
<container xmlns="http://symfony.com/schema/dic/services"
           xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
           xsi:schemaLocation="http://symfony.com/schema/dic/services http://symfony.com/schema/dic/services-1.0.xsd">

    <services>

        <service id="InfoPlusCommerce\Controller\LogFileController" autowire="true" autoconfigure="true" public="true"/>

        <service id="InfoPlusCommerce\Service\ConfigService">
            <argument type="service" id="Shopware\Core\System\SystemConfig\SystemConfigService"/>
        </service>



        <service id="InfoPlusCommerce\Client\InfoplusApiClient">
            <argument type="service" id="InfoPlusCommerce\Service\ConfigService"/>
            <argument type="service" id="InfoPlus.logger"/>
            <argument type="service" id="limiter.infoplus_user_limiter"/>
            <argument type="service" id="limiter.infoplus_domain_limiter"/>
        </service>
        <service id="InfoPlusCommerce\Service\SyncService">
            <argument type="service" id="InfoPlusCommerce\Service\ConfigService"/>
            <argument type="service" id="InfoPlusCommerce\Client\InfoplusApiClient"/>
            <argument type="service" id="InfoPlus.logger"/>
            <argument type="service" id="product.repository"/>
            <argument type="service" id="infoplus_category.repository"/>
            <argument type="service" id="customer.repository"/>
            <argument type="service" id="order.repository"/>
            <argument type="service" id="InfoPlusCommerce\Service\IdMappingService"/>
            <argument type="service" id="translator"/>
            <tag name="shopware.message_handler" handler="handle"/>
        </service>
        <service id="InfoPlusCommerce\MessageHandler\SyncOrdersHandler">
            <argument type="service" id="InfoPlusCommerce\Service\SyncService"/>
            <argument type="service" id="InfoPlus.logger"/>
            <tag name="messenger.message_handler"/>
        </service>

        <service id="InfoPlusCommerce\Controller\AdminSyncController" public="true">
            <argument type="service" id="InfoPlusCommerce\Service\SyncService"/>
            <argument type="service" id="translator"/>
            <tag name="controller.service_arguments"/>
            <call method="setContainer">
                <argument type="service" id="service_container"/>
            </call>
        </service>

        <service id="InfoPlusCommerce\Controller\AdminConfigController" public="true">
            <argument type="service" id="InfoPlusCommerce\Service\ConfigService"/>
            <argument type="service" id="translator"/>
            <tag name="controller.service_arguments"/>
            <call method="setContainer">
                <argument type="service" id="service_container"/>
            </call>
        </service>

        <service id="InfoPlusCommerce\Subscriber\EventSubscriber">
            <argument type="service" id="InfoPlusCommerce\Service\SyncService"/>
            <argument type="service" id="InfoPlus.logger"/>
            <tag name="kernel.event_subscriber"/>
        </service>

        <service id="infoplus_commerce.service" class="InfoPlusCommerce\Service\InfoplusCommerceService">
            <argument type="service" id="Shopware\Core\Framework\Api\Context\SystemSource"/>
            <argument type="service" id="Shopware\Core\Framework\Api\Serializer\JsonApiEncoder"/>
        </service>

        <service id="InfoPlusCommerce\Service\IdMappingService">
            <argument type="service" id="infoplus_id_mapping.repository" />
            <argument type="service" id="infoplus_order_sync.repository" />
            <argument type="service" id="plugin.repository" />
            <argument type="service" id="infoplus_category.repository"/>
        </service>

        <!-- Rate limiter storage -->
        <service id="infoplus.rate_limiter.storage" class="Symfony\Component\RateLimiter\Storage\CacheStorage">
            <argument type="service" id="cache.app"/>
        </service>

        <!-- Rate limiter configurations -->
        <service id="limiter.infoplus_user_limiter" class="Symfony\Component\RateLimiter\RateLimiterFactory">
            <argument type="collection">
                <argument key="id">infoplus_user_limiter</argument>
                <argument key="policy">fixed_window</argument>
                <argument key="limit">3</argument>
                <argument key="interval">1 second</argument>
            </argument>
            <argument type="service" id="infoplus.rate_limiter.storage"/>
        </service>

        <service id="limiter.infoplus_domain_limiter" class="Symfony\Component\RateLimiter\RateLimiterFactory">
            <argument type="collection">
                <argument key="id">infoplus_domain_limiter</argument>
                <argument key="policy">fixed_window</argument>
                <argument key="limit">10</argument>
                <argument key="interval">1 second</argument>
            </argument>
            <argument type="service" id="infoplus.rate_limiter.storage"/>
        </service>
        <service id="InfoPlusCommerce\Command\SyncCommand">
            <argument type="service" id="InfoPlusCommerce\Service\SyncService"/>
            <argument type="service" id="InfoPlus.logger"/>
            <argument type="service" id="order.repository"/>
            <tag name="console.command"/>
        </service>
        <service id="InfoPlusCommerce\Core\Content\IdMapping\IdMappingDefinition">
            <tag name="shopware.entity.definition" entity="infoplus_id_mapping"/>
        </service>
        <service id="InfoPlusCommerce\Core\Content\OrderSync\OrderSyncDefinition">
            <tag name="shopware.entity.definition" entity="infoplus_order_sync"/>
        </service>
        <service id="InfoPlusCommerce\Core\Content\InfoplusCategory\InfoplusCategoryDefinition">
            <tag name="shopware.entity.definition" entity="infoplus_category"/>
        </service>
        <service id="InfoPlusCommerce\ScheduledTask\SyncPaidOrdersTask">
            <tag name="shopware.scheduled.task" />
        </service>
        <service id="InfoPlusCommerce\ScheduledTask\SyncPaidOrdersTaskHandler">
            <argument type="service" id="scheduled_task.repository" />
            <argument type="service" id="InfoPlusCommerce\Service\SyncService" />
            <argument type="service" id="InfoPlusCommerce\Service\IdMappingService" />
            <argument type="service" id="order.repository" />
            <argument type="service" id="Shopware\Core\System\StateMachine\StateMachineRegistry" />
            <argument type="service" id="logger" />
            <tag name="messenger.message_handler" />
        </service>
        <service id="InfoPlusCommerce\ScheduledTask\SyncProductInventoryTask">
            <tag name="shopware.scheduled.task" />
        </service>
        <service id="InfoPlusCommerce\ScheduledTask\SyncProductInventoryTaskHandler">
            <argument type="service" id="scheduled_task.repository" />
            <argument type="service" id="InfoPlusCommerce\Service\SyncService" />
            <argument type="service" id="InfoPlusCommerce\Service\IdMappingService" />
            <argument type="service" id="product.repository" />
            <argument type="service" id="logger" />
            <tag name="messenger.message_handler" />
        </service>
        <!-- Logger -->
        <service id="InfoPlus.logger" class="Monolog\Logger">
            <argument type="string">InfoPlus</argument>
            <argument type="collection">
                <argument type="service" id="InfoPlus.rotatingHandler"/>
            </argument>
        </service>

        <service id="InfoPlus.rotatingHandler" class="Monolog\Handler\RotatingFileHandler">
            <argument type="string">%kernel.logs_dir%/InfoPlus-log-%kernel.environment%.log</argument>
        </service>
        <!-- End Logger -->
    </services>
</container>